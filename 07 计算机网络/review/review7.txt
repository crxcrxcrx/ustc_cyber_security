7 网络层(Internet的IP协议)

7.1 Internet 基本协议栈
    应用(用户空间, 信息处理)
        应用层
            HTTP(TCP)
            DNS(TCP)
            FTP(TCP)
            SMTP(TCP或UDP)
            POP3(UDP)
    网络栈(内核空间, 通信)
        传输层
            TCP(IP)
            UDP(IP)
        互联网层(IP层)
            IP
            ICMP(IP)
            IGMP(IP)
    驱动(内核空间, 通信)
        网络接口层
            802
            ARP(802)
            RARP(802)
    Internet是可扩展的, 可扩展性体现在异构性和效率
    以IP为核心的细腰架构
    基于IP的尽力服务模型实现简单, 保证传输效率(拥塞就丢包, 不顾及用户)
    为了使网络尽可能简单, IP是尽力传送服务
        不可靠, 无确认无连接的服务
        乱序, 每个分组独立转发

7.2 IP地址
    IANA 
        Internet Assigned Numbers Authority
        互联网编号分配机构
    ISP
        Internet Sercive Provider
        网络服务提供商
    DHCP
        Dynamic Host Configuration Protocol
        动态主机配置协议
    IP由IANA分配管理, 由ISP和企业申请
    IPv4共32位, 分成5类
        A, 最高1位0, 7位网络号, 24位主机号
        B, 最高2位10, 14位网络号, 16位主机号
        C, 最高3位110, 21位网络号, 8位主机号
        D, 最高4位1110, 组播地址, 标识一个组地址
        E, 最高4位1111, 保留地址
        特殊IP
            广播
                全1, 本网络内有限广播
                网络号, 主机号全1, 向网络号定向广播
            测试
                全0, 对本网络测试
                网络号全0, 主机号, 对本网络主机测试
            第一字节01111111, 后面任意, 是回环地址
    IP配置方法
        手动配置
        拨号上网(PPP协议)
        DHCP
            客户/服务器模型, UDP协议封装
            IP地址分配机制
                自动分配(永久分配)
                动态分配(一段时间有效)
                手动分配(管理员分配, DHCP只负责报告地址)
            分配过程
                客户端广播DHCPDiscover消息
                    消息包含源IP全0, 目的IP全1, 用MAC地址标识客户端
                服务器们回应DHCPOffer消息
                    消息包含分配的IP地址, 租用期限等参数
                客户端广播DHCPRequest消息
                    消息包含选择的服务器以及其分配的IP
                被选定的服务器回应DHCPACK消息
                    消息包含配置的参数
                客户端对接收到的DHCPACK检查
                    然后就可以使用了
            释放过程
                客户端向服务器发送DHCPRelease消息
                    消息包含客户端MAC地址
                    然后就可以释放IP了
            DHCP可以中继

7.3 地址解析协议(IETF)
    ARP
        Address Resolution Protocol
        地址解析协议
    RARP
        Reverse Address Resolution Protocol
        反向地址解析协议
    VLAN    
        Virtual Local Area Network
        虚拟局域网
    用于查找目的主机IP
    IP地址与MAC地址的区别
        IP
            32位
            全局标识不同节点
            含有网络号前缀, 与节点位置有关
        MAC
            48位
            链路以及局域网内标识不同节点
            固化在设备内
    数据在不同链路传输, 源和目的MAC地址变, 但是IP地址不变
    ARP过程(IETF)
        若在同一个网络内(同一个广播域)
            每个主机都有ARP缓存, 即MAC地址与IP地址的对应关系
            主机先找ARP缓存, 找到直接发, 没找到就广播ARP请求, 内含目的IP
            目的IP对应主机返回ARP响应, 内含MAC地址
            主机收到后发送数据帧, 并把映射存到ARP缓存中
        若不在同一个网络内(不同广播域, 同一个网段)
            代理ARP
                代理ARP可以帮助广播域外的主机响应ARP请求
            使用缺省路由
                直接给缺省路由器, 由它负责转发
            两种方案主机发出的目的MAC地址均为路由器
    存在针对ARP的攻击
        ARP Spoofing, 攻击者伪造被请求的ARP
        防范方法
            监测流量内容
            划分子网或VLAN隔离ARP广播域
            在ARP缓存静态配置IP和MAC地址映射表
    RARP(IETF)
        用于查找自己IP, 针对无法自己得知IP的小型设备
    帧格式
        2B 2B 1B  1B  2B  6B 4B 6B 4B
        HT PT HAL PAL OPR SM SI DM DI
    HT
        硬件类型, 如Ethernet为0x0001
    PT
        协议类型, 如IP协议为0x0806
    HAL 
        硬件地址长度
    PAL
        协议地址长度
    OPR
        操作, 1ARP请求, 2ARP响应, 3RARP请求, 4RARP响应
    SM
        源MAC地址
    SI
        源IP地址
    DM
        目标MAC地址
    DI
        目标IP地址
        若广播, 则DM为全1
        若组播, 则DM为0x01005E+低24位的DI(最高位是0, 剩下的是DI低23位)
            组播地址低28位不同, 这可能多对一
    对于802帧的Len段, 标识为0806, 此时高层用ARP/RARP

7.4 IP协议
    MTU 
        Maximum Transmission Unit
        最大传输单元
    帧格式
        4bit 4bit 1B  2B 2B 3bit 13bit 1B  1B  2B  4B 4B 0<=40B  nB
        Vers Len  ToS TL ID Flag FO    TTL Ptc Cks SI DI Opt+Pad Data
    Vers
        版本号, IPv4为4, IPv6为6
    Len
        分组头长度, 单位是4字节, 要求>=5, 缺省5
    ToS
        服务类型
        前3位是优先级, 数字越大优先级越高
        4到7位是延时, 吞吐量, 可靠性, 代价, 为1分别为低, 高, 高, 低
        最后一位是0
    TL
        总长度, 单位是B, 描述包括头在内的总长
    ID 
        标识符, 用于唯一标识分组
    Flag
        标志
        第1位未定义
        第2位是分段情况, 为1不可分段
        第3位是分段后继, 为1还有后续分段
    FO
        段偏移, 单位是8字节, 标明当前分段数据开始在原分组相对位置
    TTL
        生存时间, 单位是s(实际操作时是跳), 分组每经过一个路由器, TTL-1
        不同操作系统设定的TTL不同
    Ptc
        高层协议, 指数据域的协议, 1ICMP, 6TCP, 17UDP
    Cks
        分组头16位校验和, 只计算IP头(当然包含Option+Pad), 检测是否损坏
        由于TTL变化, 所以每次经过路由器都要重新计算
    SI
        发送者IP地址
    DI
        接收者IP地址
    Opt+Pad
        可选项, 如果有则必须填充到4字节的整数倍
        用于提供排错, 测量, 安全等措施
        增加功能, 但是增加了路由器开销, 不过这部分很少用
    Data 
        数据段, 可以是网络层也可以是传输层的PDU
    IP分段
        分段在网络层, 但是重组分段在传输层
        由于数据链路层的数据段长度限制(46到1500B)
        路由分段最大值是MTU
        MTU计算需要包含IP头!
        段偏移FO计算时要注意单位是8字节, 因此分组需要以8字节为单位

7.5 IP路由和转发
    IGP
        Interior Gateway Protocols
        内部网关协议, 域内路由协议
    EGP
        Exterior Gateway Protocols
        外部网关协议, 域间路由协议
    BGP
        Border Gateway Protocol
        边界网关协议, 外部网关协议的一种
    IP寻址
        一个IP标识一个主机或者路由器的一个接口
        一个主机若连接两个网络时会有两个IP, 叫多接口主机
        一个路由器至少连接两个网络, 原则上至少两个IP, 一个出口对应一个
    分组转发
        根据目的IP地址检查路由表进行转发
        路由表至少有目的网络以及下一跳的对应
        路由表可以非自适应手动配置也可以自适应通过协议自动进行动态维护
        分为显式路由和缺省路由, 缺省路由可以缩短路由表表项
        路由表和转发表不尽相同
            路由表有网络号和下一跳等
            转发表有网络号, 接口, MAC地址等
            转发表由路由表生成
            但是一般两者不做区分
        路由选择
            通过路由协议建立路由表的过程
        路由转发
            路由器等设备接受分组
            根据分组目的地址查询路由表
            按照指定端口转发
        路由协议
            自治系统AS
                同一个实体控制下且具有相同路由选择策略的IP网和路由器的集合
                也称为路由选择域
            协议分两类, IGP和EGP
            IGP
                RIP协议, 基于DV算法
                    上层使用UDP协议(快速)
                    适合变化不大的网络, 变化仅告诉相邻节点
                    收敛慢
                OSPF协议, 基于LS算法
                    直接走IP协议(简单)
                    适用于规模大的网络, 允许将广播域划分成小区
                    允许到同一位置路由相同开销
            EGP
                BGP协议, 基于DV算法!
                    上层使用TCP协议(稳定)
                    适合规模庞大需要边界路由代表的网络
                    周期性检测发送keepalives数据保证TCP连接
                    可发送update数据更新消息
                    可扩展到大规模网络连接全球

7.6 ICMP协议(IETF)
    ICMP
        Internet Control Message Protocol
        互联网控制报文协议
    IP是尽力服务, 如果出错就通过ICMP来发送错误报告
    是网络层协议, 但是也需要IP封装
    同样也是无连接的协议, 因此不可靠
    定义了两类报文
        差错报文
            如超时报文, TTL为0报错
        信息报文
            如回音请求响应报文, 用来ping
    网络诊断工具
        ping
            利用回音请求响应报文来测试主机可到达性, 延迟以及丢包率
        traceroute
            利用TTL从0递增, 发现主机到目的主机路径的网络节点

7.7 IGMP协议(IETF)
    IGMP
        Internet Group Management Protocol
        互联网组成员管理协议
    用于IP组播
        一对多或多对多的传输方式, 与单播相对
        用D类地址作组播地址
        分成两类, 永久组地址和临时组地址
    组播路由协议
        基于源的组播协议, 以发送端为多播树的根, 包含所有组成员
            DVMRP, MOSPF
        基于共享树的组播协议, 对每个组使用同一棵树
            CBT
        混合型协议
            PIM系列的PIM/DM, PIM/SM
    IGMP嗅探可以让二层交换机识别在组内的主机, 不会局域网全广播, 而是只给组员

7.8 IPv4的可扩展性
    CIDR
        Classless InterDomain Routing
        无类别域间寻路
    VLSM
        Variable Length Subnetwork Mask
        可变长子网掩码
    NAT 
        Network Address Translation
        网络地址转换
    问题
        地址空间不足以及地址分配不合理
        非层次化地址分类导致路由表膨胀
    解决方法
        层次地址结构
            提高IP利用率, 划分子网
                大的ABC类网络可以把主机号划分成子网ID+主机号形成子网
                子网掩码配置在每个主机上
                    子网掩码和IP地址等长, 用于与IP地址逻辑与形成子网号
                    可以用"IP地址/掩码bit数"表示
                划分子网方法
                    根据子网数量<2^n确定n, 子网号长度为网络号长度+n
                    根据主机数量<2^m-2确定m, 主机号长度为m(保留路由器和广播)
                    根据子网号长度确定子网掩码, 根据子网掩码确定子网号
                    根据子网掩码和子网号确定转发表
                此时路由表是子网号, 子网掩码和下一跳
            汇聚IP地址, 减少路由协议和路由表网络号数量, CIDR与VLSM(IETF)
                可变长度网络前缀来取代固定的网络号
                有相同前缀的连续IP地址组成CIDRBlock, "IP地址/网络前缀长度"
                CIDR用于组合子网络, VLSM用于划分子网络
                如果多个表符合规定, 则采用最长前缀的匹配规则
                此时路由表是网络前缀/前缀长度和下一跳
        共享全局IP
            通过转换网络地址, NAT
                私有IP地址
                    1A 10.0.0.0-10.255.255.255
                    16B 172.16.0.0-172.31.255.255
                    256C 192.168.0.0-192.168.255.255
                NAT转换是把源IP地址与本地IP地址进行相互转换
                网络只有一个全局IP, 剩下的都是虚拟IP
                问题
                    很难区分出主机, 需要TCP或者UDP端口号区分
                解决方法
                    新增端口号区分不同主机的端口号
                因为改变IP头标, 所以需要重新计算检验和
                此时增加NAT转换表, 表明输入输出方向, 原IP/Port, 新IP/Port
        最终方法是IPv6
        
7.9 IPv6协议
    128位, 16B, 分成8组, 冒号分隔, 简化头标, 增加安全功能
    IPv6头分成两部分,头的外层中间路由器处理, 内层目的节点处理
    没有IPv4的广播, 被组播代替