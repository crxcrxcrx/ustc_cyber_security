6 Firewall and NAT

6.1 防火墙定义
    防火墙
        位于两个或多个网络间的网间访问控制组件
            内外之间所有网络数据流必须经过防火墙
            只有符合安全政策的数据流能通过
            防火墙自身可抗攻击
        防火墙=硬件+软件+控制策略
    防火墙必要性
        保护内部不受Internet的攻击
        创建安全域
        强化机构安全策略
    两大要求, 有一定矛盾性
        保障内网安全
        保证内外联通
    防火墙功能
        访问控制
            隔断
            过滤
            代理
        加密
        授权认证
        地址翻译NAT
        VPN
        负载均衡
        内容安全
            病毒扫描
            URL扫描
            HTTP过滤
        日志记账与审计报警
    防火墙局限性
        无法阻止绕开防火墙的攻击
        无法阻止内部攻击
        无法阻止全新威胁
        无法阻止病毒感染文件传输
        端到端加密会限制防火墙能力
        对用户不完全透明, 有延迟, 瓶颈, 单点失效
        最新的无线局域网和手持移动终端的冲击

6.2 防火墙分类
    DMZ 
        DeMilitarized Zone 
        非军事区或停火区
    IDS 
        Intrusion Detection System 
        入侵检测系统
    防火墙分类
        包过滤防火墙, 网络层
        状态检测防火墙, 网络层
        应用级网关防火墙, 应用层
        代理服务防火墙, 电路级网关, 传输层
        复合型防火墙
    包过滤防火墙
        基本思想
            对于每个进入路由器的包, 适用一组规则决定转发或丢弃
            往往配置双向
            网络层监测, 不考虑连接状态
            通常在路由器上实现
        优点
            实现简单
            用户透明
            效率高 
        缺点
            正确制定完全符合安全特性的规则不容易
            不可能引入认证机制
        防火墙规则
            源端 源端口 目的端 目的端口 许可情况 协议名
        方法
            以IP和传输层的头标进行过滤
                源和目标IP地址, IP协议域(协议编号), 源和目标端口号(五元组), 接口
            建立一组规则, 根据包是否符合匹配规则来进行决定
                若匹配, 则进行规则的动作
                若不匹配, 则缺省策略
            两种缺省策略
                未被禁止即允许
                    管理员必须针对每一种新的攻击指定新规则 
                    需要确定不安全服务禁止访问, 其余的服务被认为安全 
                    更灵活但不安全
                未被允许即禁止
                    比较保守, 按需逐渐开放
                    需要确定所有可被提供的服务以及安全性再开放
                    所有其他服务排除在外
                    十分安全, 但是服务受限
        针对包过滤防火墙攻击
            IP地址欺骗
                假冒内部IP地址
                对策
                    禁止外部接口使用内部地址
            源路由攻击
                由源指定路由发起的攻击
                对策
                    禁止这样的选项
            小碎片攻击
                利用IP分片, 把TCP头切分到不同分片中
                对策
                    丢弃太小的分片
            利用复杂协议使管理员误操作
                用FTP协议对内部探查
                对策
                    加强管理员安全意识
    状态检测防火墙
        基本思想
            通过建立一个出网TCP目录加强TCP数据流检测规则
            报文过滤机制只允许那些和目录中某连接匹配的数据流通过防火墙
        优点
            克服包过滤防火墙一少部分局限性
                只能通过简单规则控制数据流进出, 不考虑高层上下文
                具有未授权用户可利用漏洞
                两个方向上针对包的规则都说清楚往往不容易
        防火墙规则
            源端 源端口 目的端 目的端口 连接状态
        方法
            本质上还是包过滤防火墙, 根据规则进行决策
    应用级网关防火墙
        基本思想
            在应用层建立协议过滤和转发功能
            针对特定网络应用服务协议使用指定数据过滤逻辑
            过滤同时会对包进行分析统计登记, 形成报告
        优点
            克服包过滤和状态检测防火墙局限性
                可根据具体内容进行决策
                不会因满足逻辑而直接建立联系
        方法
            不仅仅分析IP和传输层的头标, 还分析数据内容
            根据规则进行决策
    代理服务防火墙
        基本思想
            跨越防火墙的网络通信分成两段, 一段是外网到防火墙, 另一段是防火墙到内部主机
            通过终止代理服务器的链接实现, 隔离防火墙内外计算机系统
            代理服务进行前三类防火墙的功能, 有问题就报警并保留攻击痕迹
        优点
            允许用户直接访问Internet
            易于记录日志
        缺点
            新的服务不能及时被代理
            每个被代理服务需要专门代理软件
            客户端软件可能需要修改重新编译或配置
            有些服务需要直接建立连接, 无法代理
            代理服务不能避免协议本身缺陷和限制
        方法
            利用代理服务器来进行前三类防火墙的工作
    复合型防火墙
        基本思想
            屏蔽路由器结构
            屏蔽主机结构
                单宿主主机, 单网卡单IP
                双宿主主机, 双网卡双IP
            屏蔽子网结构
            双机热备
                两设备共同进行, 一个坏了另一个顶上
        屏蔽路由器结构
            屏蔽路由器进行简单的包过滤功能
            优点
                投资小, 配置简单
            缺点
                访问控制列表ACL较多会影响性能
            适用对象
                网络内部主机安全性好, 规则简单
                对性能, 可靠性要求较高
        屏蔽主机结构
            包过滤路由器和堡垒主机一起构成安全系统
            堡垒主机是暴露在外部网络攻击下的计算机, 需要安全配置较好
            单宿主主机
                优点
                    对内部主机进行保护, 不允许外部主机直接访问堡垒主机之外的其他主机
                缺点
                    堡垒主机和其他主机在同一个子网
                    一旦包过滤服务器被攻破, 则没有任何阻挡
                适用对象
                    只对外提供较少服务, 外部连接比较少
                    内部主机安全配置较好
            双宿主主机
                优点
                    同时攻破包过滤服务器和堡垒主机, 内网才攻破
                缺点
                    增加了单一故障点, 影响网络吞吐量
                适用对象
                    去Internet流量较小
                    对可靠性要求不高
                    不提供对外服务
        屏蔽子网结构
            DMZ
                包含两个包过滤路由器, 即外部路由器和内部路由器
                在内网和外网建立新的子网
                有堡垒主机, 还可有多个信息服务器
            信息服务器可以是DNS, Web, Email, FTP, 代理服务器等
            外部路由器
                只允许对DMZ访问, 拒绝以内部地址为目的地址的包进入内网
            内部路由器
                保护内网, 防止Internet和DMZ的非法访问
                内网不对外提供服务, 所以拒绝外部的一切链接
                特定需要前提下可接受堡垒主机的访问
                从内部往外的访问被限制必须通过堡垒主机
        双机热备可保证稳定性
    其他和防火墙联动的安全技术
        基于网络的入侵检测系统IDS
        IPSec VPN网关

6.3 NAT技术
    NAT 
        Network Address Translation
        网络地址转换
    SNAT 
        Source Network Address Translation
        源网络地址转换
    DNAT 
        Destination Network Address Translation
        目的网络地址转换
    内部网地址
        1A 10.0.0.0-10.255.255.255
        16B 172.16.0.0-172.31.255.255
        256C 192.168.0.0-192.168.255.255
    可在边界路由或防火墙实现内外地址翻译工作
    NAT分类
        根据发起者报文分
            源网络地址转换SNAT, 又叫IP伪装
                复用内部全局地址, 减缓IP地址不足的压力
                向外网隐藏内网IP
            目的网络地址转换DNAT
                在实现SNAT环境下进行有效服务访问
                流量均衡
        根据实现方式分
            静态NAT, 内外IP一一对应
            动态NAT, 内外IP多对多
            过载NAT, 利用端口号
    NAT工作原理
        客户机将数据包发给运行NAT的计算机设备
        NAT设备将数据包端口号和内网IP地址转换成设备自身的端口号和自身公用IP
        NAT设备将数据包发给外网目的主机, 同时记录跟踪信息以便收到回复反映射
        外网设备发送应答信息给NAT设备
        NAT设备将收到的数据包端口号和IP地址转换成客户机端口号和内网IP
        NAT设备将数据包发给客户机
    SNAT工作原理
        对于传出数据包, 内部地址被映射到外部地址, 端口号也会映射, 建立映射表
        对于传入数据包, 根据映射表, 外部地址被映射到内部地址, 端口号也会映射
    DNAT工作原理
        对于向内的访问, 访问防火墙IP映射到内网某服务器主机IP