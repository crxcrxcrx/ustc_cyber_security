3 IPSec-AH和ESP

3.1 IPSec协议的引入
    AH
        Authentication Header
        认证头标
    ESP
        Encapsulate Security Payload
        封装安全载荷
    IKE
        Internet Key Exchange
        网络密钥交换协议, 一种密钥管理协议
    是网络层安全协议
    最新版本IPSec2.0
        同时支持IPv4和IPv6
        规定了IPSec整体结构
        规定了AH协议和ESP协议(认证与加密)
        密钥管理协议IKE
    IPSec的作用
        传统计算机网络没有考虑安全需求, 安全性能差
            伪造, 篡改, 重放, 窃听
        可在网络层建立端到端保护安全隧道, 对上层应用和用户透明
        安全保护范围
            点到点的链路
                由于IP分组头要用来寻路, 在路由器上需要相应安全操作(如认证和加密)
            端到端的保护
                只需在收发两端进行安全操作

3.2 IPv4和IPv6协议
    IPv6是由于地址空间不足以及路由表急剧膨胀而引入的过渡机制
        新增功能
            实时应用支持
            自动配置
            移动性
            安全性
        新特性
            扩展地址空间, 32bit扩展到128bit
            简化了头标
            改善了选项功能, 提供了安全功能
            修订了参数, 增加了流标记域
    IPv6扩展头标顺序(可跳转和交叉)
        中间路由器处理
            IPv6基本头标
            中继点选项投标
            信宿选项头标(有寻路头标)
            寻路头标
            分片头标
        目的节点处理
            认证头标
            封装化安全净荷
            信宿选项头标
    IP头标与TCP头标之间可附IPSec头标

3.3 IPSec中的安全组合SA
    SA
        Security Association
        安全组合, 安全关联
    SAD 
        Security Association Database
        安全关联数据库
    SPI 
        Security Parameter Index
        安全参数索引
    IANA 
        Internet Assigned Numbers Authority
        互联网数字分配机构
    SPD
        Security Policy Database 
        安全策略数据库
    PMTU
        Path Maximum Transfer Unit
        路径最大传输单元
    IPSec的需要
        认证
        加密算法及其参数
        密钥
        当前正使用的序列号
    SPI 
        唯一标识SA的32位整数
        由目的端确定
        包含在AH和ESP头标中
        0被保留
        1到255被IANA留作将来使用
        目前有效值是256到2^32-1
        相同的源和目的节点可以建立多个SA, 各自分别被唯一标识
    SA
        为使通信双方认证和加密算法及其参数, 密钥的一致, 相互间建立的联系
        因数据传输不同方向可能策略不同
        因此SA是单向的, 双向通信时至少建立两个SA
        通过密钥管理协议在双方间协商
        协商完毕会在它们的SAD存储该SA参数
        由三元组唯一标识{SPI, 用于输出处理的目的IP地址, 协议(如AH或ESP)}
    SPD 
        包含一个策略条目的有序表
            类似于防火墙的规则表
            通过使用一个或多个选择符确定
        选择符可以是传输层协议五元组, 也可以是其中几个子元素
            理论上可根据数据包任何一个域确定
        条目包含
            策略(是否需要IPSec处理)
                丢弃, 绕过不用IPSec, 需要加载IPSec
            SA规范
            IPSec协议
            操作模式
            算法
            对外输出处理
                应在SPD中查找指向SAD中SA的指针
    SAD 
        包含现行的一系列SA条目, 每个SA由三元组索引
        条目包含
            序列号计数器
                32位整数, 用于生成AH或ESP头的序列号
            序列号溢出
                一个标志, 用于审核序列号计数器是否溢出
            抗重放窗口
                一个32位计数器和位图确定一个输入的AH或ESP数据包是否是重放的
            AH的认证算法和所需密钥
            ESP的认证算法和所需密钥
            ESP加密算法, 密钥, 初始向量和初始向量模式
            IPSec操作模式
                传输模式
                隧道模式
            PMTU
            SA生存期
    网络协议中帧内填充的主要目的
            加密算法要求明文是某数目字节整数倍
            固定单位需要是某数目字节整数倍
            32位对齐便于分析
            隐藏实际载荷长度抵御流量分析攻击

3.4 认证头标AH
    ADV 
        Authentication Data Variable
        认证数据
    ICV 
        Integrity Check Value
        完整性校验值
    MAC 
        Message Authentation Code 
        消息验证码
    提供的服务
        无连接的数据完整性
            利用MAC
        数据源认证
            利用MAC
        抗重放保护
        不提供保密性服务！
    AH内容
        头标后是净荷, 即传输层帧
        认证数据认证的范围是不包括IP头标可变域的整个IP帧
    头标某些字段
        下一头标
            标识下一个协议的协议号
        净荷长度
        保留位
        SPI 
            安全参数索引
            此32bit和目的IP, IPSec协议名联合组成三元组来确定SA
            进而可以确定SPD条目
            建立新的SA时, SPI产生由目的系统选择, 另一端采用目的地址和SPI值标识SA
        序列号
            单调增加的32位无符号整数, 用于防御重放攻击
            每个IPSec分组依次将序列号+1, 但不会对包进行排序
            防重放窗口
                收到窗口内新包且验证通过, 直接标记
                接受包超过窗口右边界且验证通过, 窗口右移, 新包成为右边界
                接受包超过左边界或未通过验证, 丢弃包
        ADV
            认证数据
            长度可变, 32bit整数倍, 也被称为IP包ICV
    AH处理
        源端外出处理
            使用相应选择符查找SPD, 获取策略
                选择符是目的IP, 端口号和传输协议等
            如需对分组进行IPSec处理
                若到目的主机的SA已建立
                    符合分组选择符的SPD将指向外出SAD的一个或多个SA
                若SA未建立
                    IPSec调用IKE协商一个SA, 并将其加到SPD条目上
            产生或增加序列号
                新的SA建立时, 序列号计数器初始化为0, 以后每发个分组, 序列号自增
            计算ICV
            转发分组到目的节点
        目的端进入处理
            如分组无IPSec选项
                分组中选择符进入SPD查找域选择符分配策略
                检查策略是否相符
                如无需进行IPSec处理
                    放行
                如需进行IPSec处理 
                    丢弃
            使用IP分组头中的SPI, 目的IP和IPSec, 进入SA数据库查SA
                如查找失败, 则抛弃分组, 记录事件
            使用已查到的SA进行IPSec处理
            检查序列号是否为重放分组
            使用SA指定的MAC算法计算ICV, 并与认证数据域的ICV比较
                如两值不同, 则丢弃分组
                ICV的计算
                    根据SA指定的算法和密钥对IP分组计算出MAC
                    MAC计算包括IP头标, 计算时将可变域置0, 不变域和可预测域不变
                        但是隧道模式下, 内部IP头标可变域不用设0
                    ICV长度依赖使用的MAC算法, 如果ICV的bit数不是32整数倍, 需填充

3.5 封装安全载荷头标ESP
    提供服务
        无连接的数据完整性(可选项目, 不覆盖IP头标)
            利用MAC
        数据源认证
            利用MAC
        抗重放保护
        数据保密
            采用对称密码体制加密数据
    ESP内容
        头标后是净荷, 即传输层帧
        先加密后认证
        加密数据加密的范围是TCP帧和ESP尾标
        认证数据认证的范围是从ESP头标到ESP尾标
            认证是可选的
            认证的数据附在IP帧后
    ESP加密范围是原IP帧
    ESP认证范围是ESP头标到尾标的部分, 包含尾标不包含头标
    头标某些字段
        填充域
            可选字段, 为对齐待加密数据让数据是从4字节位
        填充长度
            以字节为单位指示填充项长度
            范围0-255
            保证加密数据长度适合分组加密算法长度
            也可以用于对抗流量分析
        下一头标    
            标识下一个协议的协议号
        认证数据
            可变长字段, 只有选择了认证服务才需要该字段
    ESP处理
        源端外出处理
            使用相应选择符查找SPD获取策略
                选择符是目的IP, 端口号, 传输协议等
            如需对分组进行IPSec处理 
                若到目的主机的SA已建立 
                    符合分组选择符的SPD将指向外出SPD中的一个或多个SA 
                若SA未建立
                    IPSec调用IKE协商一个SA, 并将其加到SPD条目上
            产生或增加序列号
                新的SA建立时, 序列号计数器初始化为0, 以后每发个分组, 序列号自增
            加密分组， SA指明加密算法， 一般是对称加密算法
            计算可选的ICV
        目的端进入处理
            使用IP分组头中的SPI, 目的IP和IPSec, 进入SA数据库查SA
                如查找失败, 则抛弃分组, 记录事件
            策略验证
                使用分组的选择符进入SPD中查找与之匹配的策略
                根据策略检查分组是否满足IPSec处理要求
            检查序列号是否为重放分组
            如SA指定认证， 则检查数据完整性
            解密

3.6 IPSec的传输模式与隧道模式
    传输模式
        AH或ESP头标在IP头标之后, 在传输层协议前
        保护IP载荷, 提供认证, 完整性和机密性
    隧道模式
        AH或ESP头标在IP头标之前, 另外生成一个新的IP头标放在最前面
        隧道起点和终点网关地址就是新的IP头源和目的的IP地址
        保护整个IP分组, 提供认证, 完整性和机密性
    优点
        对边界所有流量强制实现安全性, 内网无需关注开销
        对上层协议, 终端用户透明
        构建安全虚拟专用网

3.7 IPSec与NAT
    NAT 
        Network Address Translation
        网络地址转换
    NATPT 
        Network Address Translation Protocol Translator
        网络地址转换的协议转换器
    NAT的PT通常在防火墙或网关上实现, 对过往的IP地址和端口号转换
    具有AH或ESP头标的IP分组不能穿过NAT和NATPT
        地址修改导致接收端AH认证失败
        上层端口号信息被ESP加密, 端口无法得知无法NATPT
        上层TCP/UDP校验需伪头标, 包含IP地址和端口, ESP认证无法修改校验字段, 验证会失败
        针对ESP问题, IETF的建议方案是在ESP头标前加一个UDP头标

3.8 IPSec隧道模式的应用VPN
    VPN 
        Virtual Private Networks
        虚拟专网
    虚拟专网中, 任意两个节点的连接并非端到端物理链路, 而是利用某种公众网资源动态组成的
    IETF草案理解基于IPSec的VPN为
        使用IPSec机制在公共网上仿真一个私有广域网
    利用了隧道技术在公共数据网络仿真一条点到点专线技术
    名字解释
        虚拟指的是用户无需实际的专用线路, 而是使用公共线路
        专用网络指的是用户可以按自己需求制定最符合自己需求的网络
    IPSec VPN是利用IPSec技术在Internet建立的VPN

3.9 IPSec的实现
    有一部分持续更新, 有一部分已经不再更新了