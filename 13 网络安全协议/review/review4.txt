4 IPSec-IKE

4.1 IKE 
    IKE 
        Internet Key Exchange 
        因特网密钥交换协议
    ISAKMP
        Internet Security Association and Key Management Protocol
        Internet安全关联和密钥管理协议
    IKE内容
        一个密钥交换协议
        受保护的方式动态协商IPSec SA的协议
    IKE功能
        使用某种长期密钥进行双向认证并建立会话密钥
            协商通信参数, 安全特性(可选)
            认证通信对端
            保护实体的标识等(可选)
            用安全的方法产生交换和建立密钥
            管理和删除安全关联
            长期密钥包括
                共享秘密密钥
                只用于签名的密钥
                用于加密的密钥
    IKE版本
        第一版本
            本质上是一个混合协议, 一个框架两个协议
            IKEv1
            ISAKMP
            Oakley密钥确定协议
            SKEME
            IPSec DOI
        第二版本
            原理和功能基本相同, 协议设计上极大优化
            IKEv2
            IKEv2 CIG 
            后续修订版本
            功能细化或扩展版本
    IKE头标
        头标某些字段
            通用载荷头
                定义了载荷边界, 所以可以连接不同载荷
            安全关联载荷
                用于协商SA的相关属性, 是一个嵌套的层次结构
                一个SA包含若干P载荷, 一个P载荷包含若干T载荷
                    P载荷, 提议载荷, Proposal
                    T载荷, 转换载荷, Transform
            提议载荷
                包含SA协商中需要的信息, 协商的协议
            转换载荷
                定义协议中使用的密码算法
            密钥交换载荷
                规定生成密钥的数据
            标识载荷
                用于通信双方交换身份信息
            证书载荷
                提供通过IKE传递证书或其他与认证相关的信息的手段
            证书请求载荷
                提供了通过IKE请求证书的手段
                在IKE交换任何时, 发送端可包含一证书请求载荷来请求通信对端提供证书
                该载荷可列出多个可接受证书类型和多个可接受认证中心
                若存在多个可信任认证中心, 且Cert编码域不许以列表发送
                    则可发送多个证书请求载荷
            认证载荷
                包含了用于认证的数据, 目前定义的认证方式包括RSA签名, MAC, DSS等
            现时载荷
                由发起者和响应者分别提供
                保证交换及时性的随机数据, 用来阻止重复攻击

4.2 IKEv1
    DSS
        Digital Signature Standard
        数字签名标准
    两个阶段
        第一阶段, 为建立IKE本身使用的安全信道而相互交换SA
            ISAKMP SA, 双向
        第二阶段, 利用第一阶段建立的安全信道交换IPSec通信中使用的SA
            IPSec SA, 单向
    一个框架ISAKMP, 希望独立于具体密钥协商算法
    部分使用Oakley和SKEME协议
    ISAKMP
        提供密钥管理架构
        定义SA的建立, 协商, 修改, 删除规程和分组格式
        独立于密钥交换协议, 加密算法和认证算法
            由Oakley密钥确定协议来确定密钥交换算法
        上层使用UDP, 端口号500
    IKEv1第一阶段
        目的
            建立ISAKMP SA, 即安全信道
        步骤(交换3, 6个报文)
            协商安全参数
            DH密钥交换
            认证实体
        交换模式
            主模式
                在IKE中必须配置主模式
                    预共享密钥认证
                    数字签名认证
                    公钥加密认证
                        传统的公钥加密认证因四次公钥加解密, 有浪费计算资源的问题
                        可用修正的公钥加密认证, 需要两次公钥加解密
            野蛮模式
                用来简化规程和提高处理效率
        认证方式
            预先共享密钥
            数字签名, 如DSS或RSA
            公钥加密, 如RSA或ElGamal
            修订的公钥加密方式
        阶段的属性
            群描述
                是预先定义的
            群类型(协商)
                模指数群
                有限域的椭圆曲线群
            加密算法
                密钥长度
                分组大小
            哈希算法
            生存时间
    IKEv1第二阶段
        目的
            建立IPSec SA, 而第一阶段建立的SA可建立多个第二阶段的SA
        步骤(交换3个报文)
            协商安全参数
            可选的DH密钥交换
            可选的身份认证
        交换模式
            快速模式
                A->B, 加密的密钥
                B->A, 同一个加密的密钥证明自己知道了
                A->B, 之前的标识, 证明A知道B知道了
                

4.3 IKEv2
    MOBIKE
    第二版本出现原因
        新的考虑
            NAT穿越
            EAP中的Legacy Authentication
            移动场景下远程地址获取
                MOBIKE协议
        旧的反思
            原有标准提供部分功能几乎很少使用
                数据结构和协议可以简化
            高强度密钥虽然有高安全性, 但计算量负担大,
                减少频繁协商次数, 避免使用大强度密钥
            安全关联需要多轮协商, 通信资源可以减少
                应减少和简化交互次数从而提高IKE效率
    部分修改内容
        新的考虑
            通过消息成对和使用序列号使得协议更可靠
            Rekey操作可以实现由任意一方任何时候发起
                IKE SA和Child SA均可以Rekey
            支持NAT-T, 扩展认证和远程地址获取等
        旧的反思
            文档改进
                继续尝试一个文档描述方案, 虽然也没完全做到
            交换方式改进
                IKEv1中八种交换(4认证方式*2交换模式)简化为初始交换只包含4个消息
            两个阶段, 但是名称和方式有点改变
                IKE SA和Child SA2
            优化认证方式
                证机制中的修改只影响单一一个认证载荷
                无需重构整个交换
            去掉不常用字段
                定义了新载荷, 对部分载荷重定义
            无SA生存时间协商
                每个节点强制执行自身的生存时间策略
            Cookie的实现机制被修改
    三个阶段
        初始交换阶段
            建立IKE本身使用的安全信道而相互交换SA
                交换IKE SA和最初的Child SA
                包含两对消息
                    IKE SA的初始值
                        用来协商加密算法
                        可选指示信任的CA名字
                        交换现时值
                        实现DH交换
                        若响应者没有一个密码套件是可接受的, 或发起者DH组不是响应者选择
                            可重发这对消息
                    IKE SA的认证
                        认证先前的消息
                        交换标识符和证书
                        建立第一个Child SA或者用于AH或ESP中的EPSec SA
                        这对消息是通过上一步建立的密钥来加密和完整性保护的
                            标识符被隐藏防止窃听
                            在消息中的字段基于完整性保护可认证
            认证方式
                基于预共享密钥的MAC
                数字签名, 如DSS或RSA 
                EAP方法
        Create Child SA阶段 
            更新IKE SA, 或者更新和创建一个新的Child SA, 一对消息
            用于创建新的Child SA或IKE SA和Child SA密钥的更新
            由单一请求响应对构成, 可在初始交换之后由IKE SA任何一端发起
                因此这阶段发起者是发送该阶段请求的端点
        Informational交换阶段
            用于删除SA, 发送错误通知, 检查IKE SA, 一对消息的存活性等
    改进的DH密钥交换
        传统的危险
            可被DoS攻击
            可被重放攻击
            可被中间人攻击
        DoS应对
            IKEv2固定头标包含各八字节的发起者SPI和响应者SPI
                用于标识SA, 也可以标识进行消息交换的节点
                对相同SPI值的请求, 一段时间内系统只处理一次
            定义携带cookie的辅助交换
                cookie在公告载荷中,抵御DoS攻击
            IKEv2消息成对出现
                每对消息中, 发起方负责重传事件, 响应者不必对响应消息重传
                    除非收到重传请求
                避免同时重传浪费消息, 也防止攻击者截获消息后伪装发起者发重传请求浪费资源
            IKEv2指通过两种情况判断是否失效
                重复尝试联系对方, 直到应答时间过期
                受对方不同的SA加密保护的Initial Contact通知信息
        重放攻击应对
            现时载荷加入保证消息更新
            消息ID也被设计主要用来防止重放攻击
        中间人攻击应对
            三种认证方式